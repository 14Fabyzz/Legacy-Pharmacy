<div class="page-container">
  <header class="page-header">
    <h2>ENTRADA DE MERCANC√çA</h2>
    <p>Registre los productos que ingresan al inventario f√≠sico.</p>
    <!-- Navegaci√≥n Compartida -->
    <nav class="tabs-nav">
      <a routerLink="/app/productos/almacen" routerLinkActive="active">
        <span class="nav-icon">üì¶</span> ALMAC√âN
      </a>

      <a routerLink="/app/productos/consulta" routerLinkActive="active">
        <span class="nav-icon">üîç</span> CONSULTA
      </a>

      <a routerLink="/app/productos/vencimientos" routerLinkActive="active">
        <span class="nav-icon">üö®</span> MONITOR ALERTAS
      </a>

      <a routerLink="/app/productos/entrada-mercancia" routerLinkActive="active">
        <span class="nav-icon">üöö</span> ENTRADAS
      </a>

      <a routerLink="/app/productos/auditoria" routerLinkActive="active">
        <span class="nav-icon">üìã</span> AUDITOR√çA
      </a>

      <a routerLink="/app/productos/nuevo" routerLinkActive="active">
        <span class="nav-icon">‚ú®</span> NUEVO
      </a>
    </nav>
  </header>

  <div class="entry-layout">

    <!-- PANEL IZQUIERDO: Formulario de Ingreso -->
    <div class="entry-form-panel card">
      <h3>Datos del Ingreso</h3>

      <form [formGroup]="entryForm" class="header-form">
        <div class="form-group">
          <label>Sucursal Destino</label>
          <select formControlName="sucursalId" class="form-control">
            <option value="1">Sucursal Centro</option>
            <!-- Iterar sucursales -->
          </select>
        </div>
        <div class="form-group">
          <label>Observaciones / No. Factura</label>
          <textarea formControlName="observaciones" class="form-control" rows="2"></textarea>
        </div>
      </form>

      <hr class="divider">

      <!-- SECCI√ìN ESC√ÅNER -->
      <div class="scanner-section" style="margin-bottom: 20px;">
        <input type="text" id="scannerInput" class="form-control scanner-input"
          placeholder="üî´ Escanear Producto Aqu√≠..." autofocus (keyup.enter)="onBarcodeScan($event)">
      </div>

      <h3>Agregar Producto</h3>
      <form [formGroup]="itemForm" (ngSubmit)="addItem()">

        <!-- Buscador de Producto -->
        <div class="form-group">
          <label>Buscar Producto (Nombre / C√≥digo)</label>
          <input type="text" class="form-control search-input" placeholder="Escribe para buscar..."
            formControlName="productoBusqueda">

          <!-- Lista de sugerencias (simulada) -->
          <div class="suggestions-list" *ngIf="showSuggestions && filteredProducts.length > 0">
            <div *ngFor="let p of filteredProducts" (click)="selectProduct(p)" class="suggestion-item">
              <strong>{{ p.nombre_comercial }}</strong> - {{ p.concentracion }}
              <small>{{ p.laboratorio_nombre }}</small>
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Lote *</label>
            <input type="text" id="campoLote" formControlName="numeroLote" class="form-control" placeholder="L-..."
              uppercase (keyup.enter)="addItemAndRefocus()">
          </div>
          <div class="form-group">
            <label>Vence *</label>
            <input type="date" formControlName="fechaVencimiento" class="form-control"
              (keyup.enter)="addItemAndRefocus()">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Cantidad</label>
            <input type="number" formControlName="cantidad" class="form-control" (keyup.enter)="addItemAndRefocus()">
          </div>
          <div class="form-group">
            <label>Costo Unitario ($)</label>
            <input type="number" formControlName="costoCompra" class="form-control" (keyup.enter)="addItemAndRefocus()">
          </div>
        </div>

        <button type="submit" class="btn btn-primary btn-block" [disabled]="itemForm.invalid || !selectedProduct">
          + Agregar a la Lista
        </button>
      </form>
    </div>

    <!-- PANEL DERECHO: Tabla de Resumen -->
    <div class="entry-summary-panel card">
      <div class="summary-header">
        <h3>Resumen de Entrada</h3>
        <span class="total-badge">Total: {{ totalCompra | currency }}</span>
      </div>

      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Lote / Vence</th>
              <th>Cant.</th>
              <th>Costo</th>
              <th>Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of addedItems; let i = index">
              <td>
                <div class="product-cell">
                  <span class="p-name">{{ item.nombreProducto }}</span>
                  <span class="p-code">{{ item.codigo }}</span>
                </div>
              </td>
              <td>
                <div class="batch-cell">
                  <span>{{ item.numeroLote }}</span>
                  <span class="date">{{ item.fechaVencimiento }}</span>
                </div>
              </td>
              <td>{{ item.cantidad }}</td>
              <td>{{ item.costoCompra | currency }}</td>
              <td>{{ item.subtotal | currency }}</td>
              <td>
                <button class="btn-icon delete" (click)="removeItem(i)">üóëÔ∏è</button>
              </td>
            </tr>
            <tr *ngIf="addedItems.length === 0">
              <td colspan="6" class="empty-state">No hay productos agregados a esta entrada.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="summary-footer">
        <button class="btn btn-success btn-lg btn-block" (click)="processEntry()" [disabled]="addedItems.length === 0">
          ‚úÖ Procesar Entrada al Inventario
        </button>
      </div>
    </div>

  </div>
</div>