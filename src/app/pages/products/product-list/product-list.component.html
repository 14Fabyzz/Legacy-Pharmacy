<div class="page-container">
  <header class="page-header">
    <div class="header-content">
      <div>
        <h2>PRODUCTOS EN ALMAC√âN</h2>
        <p>Gesti√≥n general del inventario, precios y estado de productos.</p>
      </div>
      <div class="inventory-status-pill" [ngClass]="{
             'status-critical': inventoryHealthStatus === 'critical',
             'status-alert': inventoryHealthStatus === 'alert',
             'status-healthy': inventoryHealthStatus === 'healthy'
           }" (click)="openSemaphoreModal()">

        <div class="status-icon-container">
          <!-- Icono Din√°mico -->
          <svg *ngIf="inventoryHealthStatus === 'healthy'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
            fill="currentColor" class="status-icon">
            <path
              d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z" />
          </svg>

          <svg *ngIf="inventoryHealthStatus === 'alert'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
            fill="currentColor" class="status-icon">
            <path fill-rule="evenodd"
              d="M9.401 3.003c1.155-2 4.043-2 5.197 0l7.355 12.748c1.154 2-.29 4.5-2.599 4.5H4.645c-2.309 0-3.752-2.5-2.598-4.5L9.4 3.003zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z"
              clip-rule="evenodd" />
          </svg>

          <svg *ngIf="inventoryHealthStatus === 'critical'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
            fill="currentColor" class="status-icon">
            <path fill-rule="evenodd"
              d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zM12.75 6a.75.75 0 00-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 000-1.5h-3.75V6z"
              clip-rule="evenodd" />
          </svg>
        </div>

        <span class="widget-label">Monitor de Vencimientos</span>

        <span class="count-badge" *ngIf="expiredCount > 0">{{ expiredCount }}</span>
      </div>
    </div>
  </header>

  <nav class="tabs-nav">
    <a routerLink="/app/productos/nuevo">NUEVO PRODUCTO</a>
    <a routerLink="/app/productos/almacen" routerLinkActive="active">PRODUCTOS EN ALMAC√âN</a>
    <a routerLink="/app/productos/entrada-mercancia">ENTRADA MERCANC√çA</a>
    <a routerLink="/app/productos/vencimientos" routerLinkActive="active">MONITOR VENCIMIENTOS</a>
    <a routerLink="/app/productos/consulta" routerLinkActive="active">üîç CONSULTA PRECIOS</a>
  </nav>

  <div class="search-container">
    <input type="text" class="search-input" placeholder="Buscar por nombre, c√≥digo..." [(ngModel)]="searchTerm">
  </div>

  <ng-container *ngIf="products$ | async | search:searchTerm as filteredProducts">

    <div class="product-table-wrapper">
      <table class="custom-table">
        <thead>
          <tr>
            <th style="padding-left: 20px;">Producto</th>
            <th>Referencia</th>
            <th>Laboratorio</th>
            <th>Stock</th>
            <th>Precio</th>
            <th>Estado</th>
            <th class="text-right" style="padding-right: 20px;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let product of filteredProducts">

            <!-- 1. Producto (Icono + Nombre) -->
            <td>
              <div class="product-cell-main">
                <!-- Icono -->
                <!-- Icono o Imagen -->
                <div class="product-icon-circle" (click)="openImageModal(product)" title="Ver imagen">
                  <img *ngIf="product.imagenUrl" [src]="product.imagenUrl" class="product-list-img" alt="Foto">
                  <span *ngIf="!product.imagenUrl">üíä</span>
                </div>
                <div class="product-name-wrapper">
                  <span class="product-name-text">{{ product.nombre_comercial }}</span>
                  <small class="product-subtext">{{ product.concentracion }}</small>
                </div>
              </div>
            </td>

            <!-- 2. Referencia (C√≥digo Barras) -->
            <td>
              <div class="code-cell">
                <span class="barcode-text">
                  <span class="barcode-icon">üèÅ</span> {{ product.codigo_barras }}
                </span>
                <small class="id-text">{{ product.codigo_interno }}</small>
              </div>
            </td>

            <!-- 3. Laboratorio -->
            <td>
              <span class="lab-text">{{ product.laboratorio_nombre || 'N/A' }}</span>
            </td>

            <!-- 4. Stock Badge -->
            <td>
              <div class="stock-badge-container" [ngClass]="{
                     'stock-low': (product.stock_actual || 0) < product.stock_minimo,
                     'stock-ok': (product.stock_actual || 0) >= product.stock_minimo
                   }">
                <span class="stock-value">{{ product.stock_actual || 0 }}</span>
                <span class="stock-divider">/</span>
                <span class="stock-min">{{ product.stock_minimo }} Min</span>
              </div>
            </td>

            <!-- 5. Precio -->
            <td>
              <span class="price-cell">{{ product.precio_venta_base | currency:'USD':'symbol':'1.0-0' }}</span>
            </td>

            <!-- 6. Estado -->
            <td>
              <span class="status-badge-table" [class.active]="product.estado === 'ACTIVO'">
                {{ product.estado === 'ACTIVO' ? 'ACTIVO' : 'INACTIVO' }}
              </span>
            </td>

            <!-- 7. Acciones -->
            <td class="text-right">
              <div class="table-actions">
                <button title="Ver Detalles" (click)="openDetailModal(product)" class="btn-icon">üëÅÔ∏è</button>
                <button title="Gestionar Imagen" (click)="openImageModal(product)" class="btn-icon">üñºÔ∏è</button>
                <button title="Kardex" (click)="openKardexModal(product)" class="btn-icon">üìä</button>
                <button title="Editar" [routerLink]="['/app/productos/editar', product.id]"
                  class="btn-icon edit">‚úèÔ∏è</button>
                <button title="Eliminar" (click)="openDeleteModal(product)" class="btn-icon delete">üóëÔ∏è</button>
              </div>
            </td>

          </tr>
        </tbody>
      </table>
    </div>

    <div class="no-results" *ngIf="filteredProducts.length === 0">
      <p>No se encontraron productos.</p>
    </div>
  </ng-container>

  <!-- ================= MODALES ================= -->

  <!-- 1. MODAL ELIMINAR (Confirmaci√≥n segura) -->
  <div class="modal-overlay" *ngIf="showDeleteModal && selectedProduct">
    <div class="modal-content danger">
      <h3>‚ö†Ô∏è Desactivar Producto</h3>
      <p>Est√°s a punto de desactivar <strong>{{ selectedProduct.nombre_comercial }}</strong>.</p>
      <p class="warning-text">Esta acci√≥n sacar√° el producto de la venta. Para confirmar, escribe el nombre del producto
        abajo:</p>

      <input type="text" class="confirm-input" [(ngModel)]="deleteConfirmationName"
        [placeholder]="selectedProduct.nombre_comercial">

      <div class="modal-actions">
        <button class="btn-cancel" (click)="closeModals()">Cancelar</button>
        <button class="btn-confirm-delete" [disabled]="deleteConfirmationName !== selectedProduct.nombre_comercial"
          (click)="confirmDelete()">
          Confirmar Desactivaci√≥n
        </button>
      </div>
    </div>
  </div>

  <!-- 2. MODAL DETALLES -->
  <div class="modal-overlay" *ngIf="showDetailModal && selectedProduct">
    <div class="modal-content">
      <h3>Detalles del Producto</h3>
      <div class="detail-list">
        <p><strong>Nombre:</strong> {{ selectedProduct.nombre_comercial }}</p>
        <p><strong>C√≥digo:</strong> {{ selectedProduct.codigo_interno }}</p>
        <p><strong>Presentaci√≥n:</strong> {{ selectedProduct.presentacion }}</p>
        <p><strong>INVIMA:</strong> {{ selectedProduct.registro_invima || 'N/A' }}</p>
        <p><strong>Controlado:</strong> {{ selectedProduct.es_controlado ? 'S√ç' : 'NO' }}</p>
        <p><strong>Refrigerado:</strong> {{ selectedProduct.refrigerado ? 'S√ç' : 'NO' }}</p>
      </div>
      <div class="modal-actions">
        <button class="btn-primary" (click)="closeModals()">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- 3. MODAL IMAGEN -->
  <div class="modal-overlay" *ngIf="showImageModal && selectedProduct">
    <div class="modal-content">
      <h3>Gestionar Imagen</h3>
      <div class="image-upload-area">
        <div class="current-image">
          <!-- Aqu√≠ ir√≠a la imagen real -->
          <div class="image-placeholder large">üíä</div>
        </div>
        <label class="btn-upload">
          Subir Nueva Imagen
          <input type="file" (change)="onImageSelected($event)" hidden accept="image/*">
        </label>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" (click)="closeModals()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- 4. MODAL KARDEX -->
  <div class="modal-overlay" *ngIf="showKardexModal && selectedProduct">
    <div class="modal-content large">
      <h3>Kardex: {{ selectedProduct.nombre_comercial }}</h3>
      <table class="kardex-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Movimiento</th>
            <th>Detalle</th>
            <th>Cant.</th>
            <th>Saldo</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let mov of kardexData">
            <td>{{ mov.fecha }}</td>
            <td><span class="badge" [class.in]="mov.tipo=='ENTRADA'" [class.out]="mov.tipo=='SALIDA'">{{ mov.tipo
                }}</span></td>
            <td>{{ mov.detalle }}</td>
            <td>{{ mov.cantidad }}</td>
            <td><strong>{{ mov.saldo }}</strong></td>
          </tr>
        </tbody>
      </table>
      <div class="modal-actions">
        <button class="btn-primary" (click)="closeModals()">Cerrar</button>
      </div>
    </div>
  </div>


  <!-- 5. MODAL SEM√ÅFORO -->
  <app-expiration-semaphore *ngIf="showSemaphoreModal" (close)="closeModals()"></app-expiration-semaphore>

</div>