<div class="page-container">
  <header class="page-header">
    <h2>PRODUCTOS EN ALMAC√âN</h2>
    <p>Gesti√≥n general del inventario, precios y estado de productos.</p>
  </header>

  <nav class="tabs-nav">
    <a routerLink="/app/productos/nuevo">NUEVO PRODUCTO</a>
    <a routerLink="/app/productos/almacen" routerLinkActive="active">PRODUCTOS EN ALMAC√âN</a>
    <a routerLink="/app/productos/entrada-mercancia">ENTRADA MERCANC√çA</a>
  </nav>

  <div class="search-container">
     <input type="text" class="search-input" placeholder="Buscar por nombre, c√≥digo..." [(ngModel)]="searchTerm">
   </div>

  <ng-container *ngIf="products$ | async | search:searchTerm as filteredProducts">
    
    <div class="product-list-container">
      <div *ngFor="let product of filteredProducts" class="product-card">
        
        <!-- === SEM√ÅFORO DE VENCIMIENTO (FLOTANTE) === -->
        <div class="expiry-badge" 
             [class.red]="getVencimientoStatus(product.proximo_vencimiento) === 'red'"
             [class.yellow]="getVencimientoStatus(product.proximo_vencimiento) === 'yellow'"
             [class.green]="getVencimientoStatus(product.proximo_vencimiento) === 'green'"
             *ngIf="product.proximo_vencimiento">
          <span class="expiry-icon">‚è∞</span>
          <span class="expiry-date">{{ getVencimientoLabel(product.proximo_vencimiento) }}</span>
        </div>
        <!-- ========================================== -->
         
        <!-- Imagen -->
        <div class="product-image">
          <div class="image-placeholder">üíä</div>
        </div>

        <!-- Info Producto -->
        <div class="product-info-wrapper">
          <div class="product-header">
            <span class="product-id">ID: {{ product.id }}</span>
            <h3 class="product-name">{{ product.nombre_comercial }} <small>{{ product.concentracion }}</small></h3>
            <span class="status-badge" [class.active]="product.estado === 'ACTIVO'">{{ product.estado }}</span>
          </div>

          <div class="product-details-grid">
            <div class="info-item"><dt>C√≥digo:</dt><dd>{{ product.codigo_interno }}</dd></div>
            <div class="info-item"><dt>Precio:</dt><dd class="price-text">{{ product.precio_venta_base | currency }}</dd></div>
            <div class="info-item"><dt>Lab:</dt><dd>{{ product.laboratorio_nombre || 'N/A' }}</dd></div>
            <div class="info-item"><dt>M√≠nimo:</dt><dd>{{ product.stock_minimo }}</dd></div>
          </div>
        </div>

        <!-- ACCIONES -->
        <div class="product-actions">
          <span>ACCIONES</span>
          <div class="action-icons">
            <a title="Ver Detalles" (click)="openDetailModal(product)">üëÅÔ∏è</a>
            <a title="Gestionar Imagen" (click)="openImageModal(product)">üñºÔ∏è</a>
            <a title="Kardex / Movimientos" (click)="openKardexModal(product)">üìä</a>
            
            <a title="Editar" [routerLink]="['/app/productos/editar', product.id]" class="btn-edit">‚úèÔ∏è</a>
            
            <a title="Eliminar" (click)="openDeleteModal(product)" class="btn-delete">üóëÔ∏è</a>
          </div>
        </div>

      </div> 
    </div>

    <div class="no-results" *ngIf="filteredProducts.length === 0">
      <p>No se encontraron productos.</p>
    </div>
  </ng-container>

  <!-- ================= MODALES ================= -->

  <!-- 1. MODAL ELIMINAR (Confirmaci√≥n segura) -->
  <div class="modal-overlay" *ngIf="showDeleteModal && selectedProduct">
    <div class="modal-content danger">
      <h3>‚ö†Ô∏è Desactivar Producto</h3>
      <p>Est√°s a punto de desactivar <strong>{{ selectedProduct.nombre_comercial }}</strong>.</p>
      <p class="warning-text">Esta acci√≥n sacar√° el producto de la venta. Para confirmar, escribe el nombre del producto abajo:</p>
      
      <input type="text" class="confirm-input" 
             [(ngModel)]="deleteConfirmationName" 
             [placeholder]="selectedProduct.nombre_comercial">

      <div class="modal-actions">
        <button class="btn-cancel" (click)="closeModals()">Cancelar</button>
        <button class="btn-confirm-delete" 
                [disabled]="deleteConfirmationName !== selectedProduct.nombre_comercial"
                (click)="confirmDelete()">
          Confirmar Desactivaci√≥n
        </button>
      </div>
    </div>
  </div>

  <!-- 2. MODAL DETALLES -->
  <div class="modal-overlay" *ngIf="showDetailModal && selectedProduct">
    <div class="modal-content">
      <h3>Detalles del Producto</h3>
      <div class="detail-list">
        <p><strong>Nombre:</strong> {{ selectedProduct.nombre_comercial }}</p>
        <p><strong>C√≥digo:</strong> {{ selectedProduct.codigo_interno }}</p>
        <p><strong>Presentaci√≥n:</strong> {{ selectedProduct.presentacion }}</p>
        <p><strong>INVIMA:</strong> {{ selectedProduct.registro_invima || 'N/A' }}</p>
        <p><strong>Controlado:</strong> {{ selectedProduct.es_controlado ? 'S√ç' : 'NO' }}</p>
        <p><strong>Refrigerado:</strong> {{ selectedProduct.refrigerado ? 'S√ç' : 'NO' }}</p>
      </div>
      <div class="modal-actions">
        <button class="btn-primary" (click)="closeModals()">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- 3. MODAL IMAGEN -->
  <div class="modal-overlay" *ngIf="showImageModal && selectedProduct">
    <div class="modal-content">
      <h3>Gestionar Imagen</h3>
      <div class="image-upload-area">
        <div class="current-image">
          <!-- Aqu√≠ ir√≠a la imagen real -->
          <div class="image-placeholder large">üíä</div>
        </div>
        <label class="btn-upload">
          Subir Nueva Imagen
          <input type="file" (change)="onImageSelected($event)" hidden accept="image/*">
        </label>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" (click)="closeModals()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- 4. MODAL KARDEX -->
  <div class="modal-overlay" *ngIf="showKardexModal && selectedProduct">
    <div class="modal-content large">
      <h3>Kardex: {{ selectedProduct.nombre_comercial }}</h3>
      <table class="kardex-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Movimiento</th>
            <th>Detalle</th>
            <th>Cant.</th>
            <th>Saldo</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let mov of kardexData">
            <td>{{ mov.fecha }}</td>
            <td><span class="badge" [class.in]="mov.tipo=='ENTRADA'" [class.out]="mov.tipo=='SALIDA'">{{ mov.tipo }}</span></td>
            <td>{{ mov.detalle }}</td>
            <td>{{ mov.cantidad }}</td>
            <td><strong>{{ mov.saldo }}</strong></td>
          </tr>
        </tbody>
      </table>
      <div class="modal-actions">
        <button class="btn-primary" (click)="closeModals()">Cerrar</button>
      </div>
    </div>
  </div>

</div>