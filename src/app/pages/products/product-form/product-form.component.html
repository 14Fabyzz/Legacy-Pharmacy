<div class="page-container">
  <header class="page-header">
    <h2 *ngIf="!isEditMode">NUEVO PRODUCTO</h2>
    <h2 *ngIf="isEditMode">ACTUALIZAR PRODUCTO</h2>
    <p>Registre la ficha técnica del medicamento. El stock y los lotes se gestionan en el módulo de "Compras".</p>
  </header>

  <nav class="tabs-nav">
    <a routerLink="/app/productos/nuevo" routerLinkActive="active">NUEVO PRODUCTO</a>
    <a routerLink="/app/productos/almacen" routerLinkActive="active">PRODUCTOS EN ALMACÉN</a>
    <a routerLink="/app/productos/entrada-mercancia" routerLinkActive="active">ENTRADA MERCANCÍA</a>
    <a routerLink="/app/productos/vencimientos" routerLinkActive="active">MONITOR VENCIMIENTOS</a>
  </nav>

  <form [formGroup]="productForm" (ngSubmit)="submitForm()" class="product-form">

    <!-- SECCIÓN 1: Identificación -->
    <fieldset class="form-section">
      <legend>Identificación</legend>
      <div class="form-row">
        <div class="form-group">
          <label>Código Interno / SKU *</label>
          <input type="text" formControlName="codigo_interno" placeholder="Ej: DOLEX-500">
        </div>
        <div class="form-group">
          <label>Código de Barras</label>
          <div class="input-with-icon">
            <input type="text" formControlName="codigo_barras" #barcodeInput (change)="validateBarcode()"
              (keyup.enter)="validateBarcode()">
            <button type="button" class="btn-icon-inside" (click)="focusBarcodeInput()" title="Escanear">
              <span class="icon-barcode">|||</span>
            </button>
          </div>
        </div>
        <div class="form-group full-width">
          <label>Nombre Comercial *</label>
          <input type="text" formControlName="nombre_comercial" placeholder="Ej: Dolex Forte">
        </div>
      </div>
    </fieldset>

    <!-- SECCIÓN 2: Datos Farmacéuticos -->
    <fieldset class="form-section">
      <legend>Detalles Farmacéuticos</legend>
      <div class="form-row">
        <div class="form-group">
          <label>Principio Activo *</label>
          <select formControlName="principio_activo_id">
            <option [ngValue]="null">Seleccione...</option>
            <option *ngFor="let pa of principiosActivos" [value]="pa.id">{{ pa.nombre }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Laboratorio *</label>
          <select formControlName="laboratorio_id">
            <option [ngValue]="null">Seleccione...</option>
            <option *ngFor="let lab of laboratorios" [value]="lab.id">{{ lab.nombre }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Categoría *</label>
          <select formControlName="categoria_id">
            <option [ngValue]="null">Seleccione...</option>
            <option *ngFor="let cat of categorias" [value]="cat.id">{{ cat.nombre }}</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Concentración</label>
          <input type="text" formControlName="concentracion" placeholder="Ej: 500mg">
        </div>
        <div class="form-group">
          <label>Presentación</label>
          <input type="text" formControlName="presentacion" placeholder="Ej: Caja x 10 Tabletas">
        </div>
        <div class="form-group">
          <label>Registro INVIMA</label>
          <input type="text" formControlName="registro_invima">
        </div>
      </div>
    </fieldset>

    <!-- SECCIÓN 3: Comercial y Control -->
    <fieldset class="form-section">
      <legend>Comercial y Control</legend>
      <div class="form-row">
        <div class="form-group">
          <label>Precio Venta Base ($) *</label>
          <input type="number" formControlName="precio_venta_base">
        </div>
        <div class="form-group">
          <label>IVA (%)</label>
          <input type="number" formControlName="iva_porcentaje">
        </div>
        <div class="form-group">
          <label>Stock Mínimo (Alerta)</label>
          <input type="number" formControlName="stock_minimo">
        </div>
      </div>

      <div class="form-row checkboxes-row">
        <div class="checkbox-group">
          <input type="checkbox" id="es_controlado" formControlName="es_controlado">
          <label for="es_controlado">Es Medicamento Controlado</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="refrigerado" formControlName="refrigerado">
          <label for="refrigerado">Requiere Refrigeración</label>
        </div>
      </div>
    </fieldset>

    <div class="form-actions">
      <button type="button" class="btn btn-secondary" (click)="limpiarFormulario()">Limpiar</button>
      <button type="submit" class="btn btn-primary" [disabled]="productForm.invalid">
        {{ isEditMode ? 'Actualizar Ficha' : 'Crear Ficha Técnica' }}
      </button>
    </div>
  </form>
</div>